# 字节跳动抖音基础技术部一面复盘

## 自我介绍

自我介绍真的非常重要，好像每次面试都有，包括影石等，要准备好模板（测试、客户端、后端），这里顺便问了一下到岗时间，实习地点和月数的情况。



## 轻量级linux多线程web服务器

**问题1：**详细说一下在这个项目中，用到的 IO 多路复用，对比传统的创建一个线程处理一个客户端的 HTTP 请求，你的项目有什么优势吗？

回答：开始我扭曲了面试官的意思，我把关注点聚焦在了一个线程上面，然后就说通过创建线程池来防止每一个客户端发送了 HTTP 请求就创建一个新的线程，避免了频繁地创建和销毁线程的系统开销。

这里面试官很好，他引导我说 IO 多路复用的优势（其实本质就是想问 IO 多路复用），我回答的比较草率，就说通过用户态下的程序代码，为每一个新到来的客户端 TCP 连接注册 EPOLLIN 事件，然后委托操作系统**内核**检测与客户端通信的 fd 对应 TCP 读缓冲区是否有数据到达，来代替一个线程对应一个客户端请求的方式（<font color = red>这里回答的非常不好，应该从网络编程的监听 fd 入手，详细解释在监听这一步，EPOLL是如何处理客户端的 HTTP 连接的，后续需要复习一下 IO 多路复用的具体实现机制</font>）。

**问题2：**接着问题 1 继续深入，你刚刚说到了操作系统内核会帮忙检测对应 fd 的缓冲区中是否有数据，来实现与客户端的通信，能说说内核具体是怎么实现的吗？

回答：这里直接懵了，我第一反应是我好像也没看过 linux 内核源码的实现诶（所以直接老实回答说不太会），为了避免说不太会的尴尬，我尝试回答了内核应该会有检测 TCP 通信缓冲区中是否有数据的代码逻辑，然后基于内核实现的 TCP/IP 协议来与客户端进行数据交互（<font color = red>面试中真的会降智，这个问题虽然本质不会，但是尝试回答的部分应该可以从 TCP 读写缓冲区入手，然后静下心来结合缓冲区说一下具体的 TCP 通信过程，完全是可以做到更好的</font>）。

**问题3：**还是基于问题 1 的深入，因为问题 1 谈到了 OS 的内核，这里面试官就说，你能说一下在日常编程中，使用什么函数会进入内核态吗？

回答：懵了，直接说很常见的 `printf()`，然后直接说会触发 IO 中断。（这里答案没问题，但是回答的不够深入，面试官针对这个问题也没有深入聊下去，应该说，调用了 `printf()` 函数之后，在用户态下完成格式化字符串的工作，解析`%s`占位符和`\n`字符等，当解析的过程中遇到了`\n`，程序就会通过系统调用 `write()` 将用户空间下缓冲区的字符串内容写入到内核缓冲区中，然后系统调用会触发 OS 从用户态切换到内核态）。

**问题4：**基于问题 3 的深入，在说一下什么情况下会触发 OS 从用户态切换到内核态（经典“变态”问题）。

回答：感觉也回答的比较浅，直接说了中断、异常和系统调用（比如 linux 编程中的 `read()`	和 `send()` 系统调用）。

**问题5：**还是基于问题 3的深入，既然这样的话，你觉得像 `abs()` 相关的函数执行过程中，OS 会进入内核态吗？

回答：太难崩了，当时我内心在想，这么简单的问题，现实生活中我肯定会直接说不会进入到内核态（模糊记忆的驱使，但是如果说为什么不会进入到内核态，我应该答不上来），此时内心斗争了差不多 30s 🤣，感觉有坑，我就想，求绝对值运算，首先从内存中取出变量，然后通过数据总线传入到 CPU 的寄存器中，然后进行绝对值运算...（此时思维已经很混乱了，甚至在想这会触发 CPU 的上下文切换吗，其实就是对计组、程序运行逻辑、用户态和内核态的本质等八股记得不太清楚导致的），最后用不太肯定的语气说了不会进入到内核态，面试官反问一定不会进入内核态吗，我说一定不会（这里还好回答对了，虽然问题很基础，难崩！！）。

细细回忆一下，为什么 `abs()` 不会进入 OS 内核态呢，其实本质就是该函数不需要执行系统调用，并且不存在内核系统资源的访问，也不存在硬件交互。只需要在程序的执行逻辑下，将用户空间内存中存储的变量，传给 CPU 进行运算即可，而 CPU 运算在用户态下就能完成，所以不涉及到变态。

**问题6：**回想一下，应该是对问题4的深入，给你线程 A 和线程 B，线程 B 执行的是计算密集型任务，在线程 B 占用 CPU 资源的时候，线程 A 可以抢占线程 B 的 CPU 使用权吗，如果可以抢占，具体是怎么实现的，如果不可以抢占，又是为什么？

回答：还是懵，我第一反应想的是，这不应该是线程调度的问题吗，感觉线程 A 包可以抢占线程 B 的 CPU 使用权呀，然后跟面试官举例子说，如果 OS 的线程调度是基于时间片轮转的，在每一个 TCB 中记录了线程的 CPU 剩余使用时间，然后线程 B 的时间片用完后，CPU 就会继续调度线程 A 。

回答没抓住重点，面试官解释 ==> 我知道你说的意思，但是线程 B 是计算机密集型任务，CPU 很忙，一直在执行计算任务，根本没空去检测每一个 TCB 中剩余的 CPU 使用时间，这种情况应该怎么办。

续答：第二反应，既然软的不行，就来硬的，我说 CPU 工作的时候，有它的时钟周期，可不可以在硬件的层面上（还是基于时间片轮转），当 CPU 执行到指定时钟周期之后，对 CPU 发送硬件中断信号，强制 CPU 去检测指定寄存器里面的值（这个寄存器存放了当前调度线程的剩余 CPU 使用时间），如果剩余时间小于等于 0，就触发线程调度机制。

感觉答的很不好，但是面试官没有后续追问了，应该是时间有限，继续下一个问题了。

**问题7：**看你项目 EPOLL 主要用在网络编程的客户端与服务器的数据交互中，那么在 linux 系统编程中，涉及到的进程或者线程通信，比如管道、信号、共享内存等，因为管道也是基于 fd 实现的嘛，也可以使用 IO 多路复用吗？

回答：我应该是听到了 fd 关键字，回想一下 EPOLL 的本质就是通过内核监听对应 fd 发生的事件（EPOLLIN、EPOLLOUT等），我直接肯定的回答说也可以通过 IO 多路复用实现，但是好像这里只有管道是基于 fd 的🤣。（<font color = red>其实在 webserver 项目中，有用到 EPOLL 监听管道的读端，管道的写端读取 OS 给进程发送的信号，实现了进程结束和定时器功能</font>）

应该是没有回答完全错，但是面试官没有详细问了，这个问题反映了，需要弄清楚 EPOLL 的本质就是基于 fd 的，只要是 fd，就可以用 EPOLL 注册监听的事件，并且委托内核检测之。然后就是，需要巩固 IPC 的八股内容。

**问题8：**HTTP 协议和 HTTPS 协议的区别？





## **手撕题目**

很幸运，抽到了 LC mid 原题，寻找数组中第 k 大的元素，直接小根堆，O(n) 的时间复杂度秒了。

面试官反问：用优先队列空间复杂度太高了，有没有空间复杂度不是那么高的思路，这里我的第一反应是改进快排，因为快排的每一次分治之前，都可以唯一确定一个基准所在的位置，所以，在快排的基础上，对确定基准的索引和第 k 大元素索引进行比较，如果相等，说明找到了，就不用继续分治了。

这里面试官说这个方法可以尝试一下，让我手撕写出来（真的给自己菜无语了，快排很久没写了，边界条件忘记了，然后写的非常的坎坷）。

手撕完后，面试官让我用自己的 IDE 调试去找bug，看下是哪里出错了，并且给出了优化思路，就是每次分治都只要确定 k 所在的那一部分基准即可。找了很久，还是只能过部分样例，面试官让我线下去考虑一下边界条件，最后发现就是一个等于号的问题，当时没发现（真的感觉遇到了神仙面试官，太友好了，面试体验不错）。

<font color = red>复习一下手撕快排！！！</font>



