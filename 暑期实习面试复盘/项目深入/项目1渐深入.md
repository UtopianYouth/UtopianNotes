# 面试后的 webserver 项目复盘

⭐⭐**多注意细节**

## 1.1 项目整体执行流程（简化版1）

注册信号处理、信号捕捉相关 ==> 

创建 epoll 事件数组、epoll 对象 ==> 

创建线程池对象（模板类） ==> 

创建 HTTP 任务类对象数组 ==>

创建监听的 fd 并且绑定对应的 IP 和 PORT ==> 

监听的 fd 加入到 epoll 对象中，注册 EPOLLIN ==> 

接收客户端的 TCP 连接请求、加入到 epoll 对象中并且注册 EPOLLIN 事件 ==>

 epoll_wait() 检测到与客户端通信的 HTTP 请求、创建 HTTP 任务类对象 ==> 

任务类对象调用 read() 读取 HTTP 请求的数据 ==> 

调用线程池的 append 方法将 HTTP 任务类对象加入到线程池工作队列中，信号量++ ==>

线程池中的线程逻辑函数解除信号量的阻塞，从工作队列中获取需要执行的任务类对象 ==> 

执行任务类对象的 process() 方法，调用 process_read() 解析读取到的 HTTP 请求数据，调用 process_write() 生成 HTTP 响应的结果 ==> 

修改通信的 fd 为 EPOLLOUT ==> 

内核检测到缓冲区可写，主线程调用任务类对象的 write() 将 HTTP 响应数据写入到内核缓冲区中，由内核发送 HTTP 响应的结果 ==> 

完成一次 HTTP 响应，初始化任务类对象的缓冲区和客户端信息 ==> 

检测是否保持 TCP 长连接，是，不断开，不是，断开。

### 1.1.1 涉及到的相关细节复习

**文件描述符部分**

文件描述符非阻塞

端口复用

**线程池部分**

`pthread_join()` 和 `pthread_detach()`系统调用

保证子线程结束，主线程才结束运行，主线程结束运行之前，回收子线程的系统资源。